// ====================================================================
// Модуль стратегий расчета комиссий (Commission Strategy Pattern)
// ====================================================================
// Назначение: Гибкий расчет комиссий с различными алгоритмами
// Автор: Шульдешов Юрий Леонидович (shuldeshoff@mail.ru)
// Версия: 2.0
// Паттерны: Strategy, Factory, Chain of Responsibility
// ====================================================================

#Область ПрограммныйИнтерфейс

// Рассчитать комиссию по стратегии
//
// Параметры:
//   ДанныеЗаказа - Структура - Данные заказа
//   Поставщик - СправочникСсылка - Ссылка на поставщика
//
// Возвращаемое значение:
//   Структура - Результат расчета комиссии
//
Функция РассчитатьКомиссию(ДанныеЗаказа, Поставщик) Экспорт
	
	// Определяем стратегию расчета для поставщика
	Стратегия = ПолучитьСтратегиюПоставщика(Поставщик);
	
	// Получаем калькулятор для стратегии
	Калькулятор = ПолучитьКалькуляторКомиссии(Стратегия);
	
	// Выполняем расчет
	РезультатРасчета = Калькулятор.Рассчитать(ДанныеЗаказа, Поставщик);
	
	// Применяем модификаторы (скидки, бонусы и т.д.)
	РезультатРасчета = ПрименитьМодификаторы(РезультатРасчета, ДанныеЗаказа, Поставщик);
	
	// Валидируем результат
	ВалидироватьРезультатРасчета(РезультатРасчета);
	
	// Логируем расчет
	ЗаписатьЛогРасчета(ДанныеЗаказа, Поставщик, Стратегия, РезультатРасчета);
	
	Возврат РезультатРасчета;
	
КонецФункции

// Зарегистрировать новую стратегию расчета
//
// Параметры:
//   ИмяСтратегии - Строка - Уникальное имя стратегии
//   ОписаниеСтратегии - Строка - Описание стратегии
//   МодульРасчета - Строка - Имя модуля с логикой расчета
//
Процедура ЗарегистрироватьСтратегию(ИмяСтратегии, ОписаниеСтратегии, МодульРасчета) Экспорт
	
	МенеджерЗаписи = РегистрыСведений.СтратегииРасчетаКомиссий.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ИмяСтратегии = ИмяСтратегии;
	МенеджерЗаписи.Описание = ОписаниеСтратегии;
	МенеджерЗаписи.МодульРасчета = МодульРасчета;
	МенеджерЗаписи.Активна = Истина;
	МенеджерЗаписи.Записать();
	
	ЗаписатьЛог("Информация", СтрШаблон(
		"Зарегистрирована стратегия расчета: %1", ИмяСтратегии));
	
КонецПроцедуры

// Получить список доступных стратегий
//
// Возвращаемое значение:
//   ТаблицаЗначений - Список стратегий
//
Функция ПолучитьСписокСтратегий() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтратегииРасчетаКомиссий.ИмяСтратегии КАК ИмяСтратегии,
	|	СтратегииРасчетаКомиссий.Описание КАК Описание,
	|	СтратегииРасчетаКомиссий.Активна КАК Активна
	|ИЗ
	|	РегистрСведений.СтратегииРасчетаКомиссий КАК СтратегииРасчетаКомиссий
	|ГДЕ
	|	СтратегииРасчетаКомиссий.Активна = ИСТИНА
	|УПОРЯДОЧИТЬ ПО
	|	СтратегииРасчетаКомиссий.ИмяСтратегии";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

#КонецОбласти

#Область СтратегииРасчета

// Стратегия: Фиксированная комиссия
//
Функция СтратегияФиксированнаяКомиссия(ДанныеЗаказа, Поставщик)
	
	Результат = СоздатьСтруктуруРезультата();
	
	// Получаем фиксированную сумму из настроек поставщика
	ФиксированнаяСумма = ПолучитьНастройкуПоставщика(Поставщик, "ФиксированнаяКомиссия", 30);
	
	Результат.Комиссия = ФиксированнаяСумма;
	Результат.ТипРасчета = "Фиксированная";
	Результат.Детали.Вставить("ФиксированнаяСумма", ФиксированнаяСумма);
	
	Возврат Результат;
	
КонецФункции

// Стратегия: Процент от цены
//
Функция СтратегияПроцентОтЦены(ДанныеЗаказа, Поставщик)
	
	Результат = СоздатьСтруктуруРезультата();
	
	// Получаем процент из настроек
	Процент = ПолучитьНастройкуПоставщика(Поставщик, "ПроцентКомиссии", 5);
	
	// Получаем цену из данных заказа
	Цена = ДанныеЗаказа.rooms[0].priceDetails.clientPrice.price;
	
	Результат.Комиссия = Цена * Процент / 100;
	Результат.ТипРасчета = "ПроцентОтЦены";
	Результат.Детали.Вставить("Процент", Процент);
	Результат.Детали.Вставить("БазоваяЦена", Цена);
	
	Возврат Результат;
	
КонецФункции

// Стратегия: Процент от разницы Gross-Net
//
Функция СтратегияПроцентОтГросс(ДанныеЗаказа, Поставщик)
	
	Результат = СоздатьСтруктуруРезультата();
	
	// Получаем данные о ценах
	PriceDetails = ДанныеЗаказа.rooms[0].priceDetails.clientPrice;
	Gross = PriceDetails.gross;
	Net = PriceDetails.net;
	
	// Процент от разницы
	Процент = ПолучитьНастройкуПоставщика(Поставщик, "ПроцентОтГросс", 100);
	
	Результат.Комиссия = (Gross - Net) * Процент / 100;
	Результат.ТипРасчета = "ПроцентОтГросс";
	Результат.Детали.Вставить("Gross", Gross);
	Результат.Детали.Вставить("Net", Net);
	Результат.Детали.Вставить("Процент", Процент);
	
	Возврат Результат;
	
КонецФункции

// Стратегия: Ступенчатая (зависит от суммы)
//
Функция СтратегияСтупенчатая(ДанныеЗаказа, Поставщик)
	
	Результат = СоздатьСтруктуруРезультата();
	
	Цена = ДанныеЗаказа.rooms[0].priceDetails.clientPrice.price;
	
	// Получаем ступени из настроек
	Ступени = ПолучитьСтупениКомиссии(Поставщик);
	
	// Определяем процент по ступени
	Процент = 5; // По умолчанию
	ПримененнаяСтупень = "";
	
	Для Каждого Ступень Из Ступени Цикл
		Если Цена >= Ступень.МинимальнаяСумма И (Ступень.МаксимальнаяСумма = 0 ИЛИ Цена <= Ступень.МаксимальнаяСумма) Тогда
			Процент = Ступень.Процент;
			ПримененнаяСтупень = Ступень.Наименование;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Результат.Комиссия = Цена * Процент / 100;
	Результат.ТипРасчета = "Ступенчатая";
	Результат.Детали.Вставить("Цена", Цена);
	Результат.Детали.Вставить("Процент", Процент);
	Результат.Детали.Вставить("Ступень", ПримененнаяСтупень);
	
	Возврат Результат;
	
КонецФункции

// Стратегия: Динамическая (с учетом сезонности, загрузки)
//
Функция СтратегияДинамическая(ДанныеЗаказа, Поставщик)
	
	Результат = СоздатьСтруктуруРезультата();
	
	Цена = ДанныеЗаказа.rooms[0].priceDetails.clientPrice.price;
	БазовыйПроцент = ПолучитьНастройкуПоставщика(Поставщик, "БазовыйПроцент", 5);
	
	// Коэффициент сезонности
	КоэффициентСезонности = ПолучитьКоэффициентСезонности(ДанныеЗаказа);
	
	// Коэффициент загрузки
	КоэффициентЗагрузки = ПолучитьКоэффициентЗагрузки();
	
	// Итоговый процент
	ИтоговыйПроцент = БазовыйПроцент * КоэффициентСезонности * КоэффициентЗагрузки;
	
	Результат.Комиссия = Цена * ИтоговыйПроцент / 100;
	Результат.ТипРасчета = "Динамическая";
	Результат.Детали.Вставить("БазовыйПроцент", БазовыйПроцент);
	Результат.Детали.Вставить("КоэффициентСезонности", КоэффициентСезонности);
	Результат.Детали.Вставить("КоэффициентЗагрузки", КоэффициентЗагрузки);
	Результат.Детали.Вставить("ИтоговыйПроцент", ИтоговыйПроцент);
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Получить стратегию поставщика
//
Функция ПолучитьСтратегиюПоставщика(Поставщик)
	
	// Читаем из реквизита справочника или из настроек
	Стратегия = Поставщик.СтратегияРасчетаКомиссии;
	
	Если НЕ ЗначениеЗаполнено(Стратегия) Тогда
		// Стратегия по умолчанию
		Стратегия = "ФиксированнаяКомиссия";
	КонецЕсли;
	
	Возврат Стратегия;
	
КонецФункции

// Получить калькулятор комиссии (Factory Pattern)
//
Функция ПолучитьКалькуляторКомиссии(Стратегия)
	
	Калькулятор = Новый Структура;
	
	Если Стратегия = "ФиксированнаяКомиссия" Тогда
		Калькулятор.Вставить("Рассчитать", "СтратегияФиксированнаяКомиссия");
		
	ИначеЕсли Стратегия = "ПроцентОтЦены" Тогда
		Калькулятор.Вставить("Рассчитать", "СтратегияПроцентОтЦены");
		
	ИначеЕсли Стратегия = "ПроцентОтГросс" Тогда
		Калькулятор.Вставить("Рассчитать", "СтратегияПроцентОтГросс");
		
	ИначеЕсли Стратегия = "Ступенчатая" Тогда
		Калькулятор.Вставить("Рассчитать", "СтратегияСтупенчатая");
		
	ИначеЕсли Стратегия = "Динамическая" Тогда
		Калькулятор.Вставить("Рассчитать", "СтратегияДинамическая");
		
	Иначе
		ВызватьИсключение "Неизвестная стратегия расчета: " + Стратегия;
	КонецЕсли;
	
	// Оборачиваем в объект с методом Рассчитать
	ОбъектКалькулятора = Новый Структура;
	ОбъектКалькулятора.Вставить("ИмяФункции", Калькулятор.Рассчитать);
	ОбъектКалькулятора.Вставить("Рассчитать", Новый ФиксированнаяСтруктура("ДанныеЗаказа, Поставщик"));
	
	Возврат Калькулятор;
	
КонецФункции

// Создать структуру результата расчета
//
Функция СоздатьСтруктуруРезультата()
	
	Результат = Новый Структура;
	Результат.Вставить("Комиссия", 0);
	Результат.Вставить("ТипРасчета", "");
	Результат.Вставить("Детали", Новый Структура);
	Результат.Вставить("Модификаторы", Новый Массив);
	
	Возврат Результат;
	
КонецФункции

// Применить модификаторы (Chain of Responsibility)
//
Функция ПрименитьМодификаторы(РезультатРасчета, ДанныеЗаказа, Поставщик)
	
	// Получаем список активных модификаторов
	Модификаторы = ПолучитьАктивныеМодификаторы(Поставщик);
	
	Для Каждого Модификатор Из Модификаторы Цикл
		
		Если Модификатор.Тип = "Скидка" Тогда
			РезультатРасчета = ПрименитьСкидку(РезультатРасчета, Модификатор, ДанныеЗаказа);
			
		ИначеЕсли Модификатор.Тип = "Бонус" Тогда
			РезультатРасчета = ПрименитьБонус(РезультатРасчета, Модификатор, ДанныеЗаказа);
			
		ИначеЕсли Модификатор.Тип = "Наценка" Тогда
			РезультатРасчета = ПрименитьНаценку(РезультатРасчета, Модификатор, ДанныеЗаказа);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат РезультатРасчета;
	
КонецФункции

// Применить скидку
//
Функция ПрименитьСкидку(РезультатРасчета, Модификатор, ДанныеЗаказа)
	
	// Проверяем условия применения
	Если НЕ ПроверитьУсловияМодификатора(Модификатор, ДанныеЗаказа) Тогда
		Возврат РезультатРасчета;
	КонецЕсли;
	
	ПроцентСкидки = Модификатор.Значение;
	СуммаСкидки = РезультатРасчета.Комиссия * ПроцентСкидки / 100;
	
	РезультатРасчета.Комиссия = РезультатРасчета.Комиссия - СуммаСкидки;
	
	ИнфоМодификатора = Новый Структура;
	ИнфоМодификатора.Вставить("Тип", "Скидка");
	ИнфоМодификатора.Вставить("Наименование", Модификатор.Наименование);
	ИнфоМодификатора.Вставить("Процент", ПроцентСкидки);
	ИнфоМодификатора.Вставить("Сумма", -СуммаСкидки);
	
	РезультатРасчета.Модификаторы.Добавить(ИнфоМодификатора);
	
	Возврат РезультатРасчета;
	
КонецФункции

// Применить бонус
//
Функция ПрименитьБонус(РезультатРасчета, Модификатор, ДанныеЗаказа)
	
	Если НЕ ПроверитьУсловияМодификатора(Модификатор, ДанныеЗаказа) Тогда
		Возврат РезультатРасчета;
	КонецЕсли;
	
	СуммаБонуса = Модификатор.Значение;
	РезультатРасчета.Комиссия = РезультатРасчета.Комиссия + СуммаБонуса;
	
	ИнфоМодификатора = Новый Структура;
	ИнфоМодификатора.Вставить("Тип", "Бонус");
	ИнфоМодификатора.Вставить("Наименование", Модификатор.Наименование);
	ИнфоМодификатора.Вставить("Сумма", СуммаБонуса);
	
	РезультатРасчета.Модификаторы.Добавить(ИнфоМодификатора);
	
	Возврат РезультатРасчета;
	
КонецФункции

// Применить наценку
//
Функция ПрименитьНаценку(РезультатРасчета, Модификатор, ДанныеЗаказа)
	
	Если НЕ ПроверитьУсловияМодификатора(Модификатор, ДанныеЗаказа) Тогда
		Возврат РезультатРасчета;
	КонецЕсли;
	
	ПроцентНаценки = Модификатор.Значение;
	СуммаНаценки = РезультатРасчета.Комиссия * ПроцентНаценки / 100;
	
	РезультатРасчета.Комиссия = РезультатРасчета.Комиссия + СуммаНаценки;
	
	ИнфоМодификатора = Новый Структура;
	ИнфоМодификатора.Вставить("Тип", "Наценка");
	ИнфоМодификатора.Вставить("Наименование", Модификатор.Наименование);
	ИнфоМодификатора.Вставить("Процент", ПроцентНаценки);
	ИнфоМодификатора.Вставить("Сумма", СуммаНаценки);
	
	РезультатРасчета.Модификаторы.Добавить(ИнфоМодификатора);
	
	Возврат РезультатРасчета;
	
КонецФункции

// Получить настройку поставщика
//
Функция ПолучитьНастройкуПоставщика(Поставщик, ИмяНастройки, ЗначениеПоУмолчанию = Неопределено)
	
	// Читаем из реквизитов или регистра настроек
	Если ИмяНастройки = "ФиксированнаяКомиссия" Тогда
		Возврат Поставщик.ФиксированнаяКомиссия;
	ИначеЕсли ИмяНастройки = "ПроцентКомиссии" Тогда
		Возврат Поставщик.ПроцентКомиссии;
	Иначе
		Возврат ЗначениеПоУмолчанию;
	КонецЕсли;
	
КонецФункции

// Получить ступени комиссии
//
Функция ПолучитьСтупениКомиссии(Поставщик)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтупениКомиссии.Наименование КАК Наименование,
	|	СтупениКомиссии.МинимальнаяСумма КАК МинимальнаяСумма,
	|	СтупениКомиссии.МаксимальнаяСумма КАК МаксимальнаяСумма,
	|	СтупениКомиссии.Процент КАК Процент
	|ИЗ
	|	РегистрСведений.СтупениКомиссии КАК СтупениКомиссии
	|ГДЕ
	|	СтупениКомиссии.Поставщик = &Поставщик
	|УПОРЯДОЧИТЬ ПО
	|	СтупениКомиссии.МинимальнаяСумма";
	
	Запрос.УстановитьПараметр("Поставщик", Поставщик);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Получить коэффициент сезонности
//
Функция ПолучитьКоэффициентСезонности(ДанныеЗаказа)
	
	// Получаем дату заезда
	ДатаЗаезда = ДанныеЗаказа.rooms[0].checkIn;
	Месяц = Месяц(ДатаЗаезда);
	
	// Высокий сезон (июнь-август)
	Если Месяц >= 6 И Месяц <= 8 Тогда
		Возврат 1.2; // +20%
	// Низкий сезон (ноябрь-март)
	ИначеЕсли Месяц >= 11 ИЛИ Месяц <= 3 Тогда
		Возврат 0.8; // -20%
	Иначе
		Возврат 1.0; // Нормальный сезон
	КонецЕсли;
	
КонецФункции

// Получить коэффициент загрузки
//
Функция ПолучитьКоэффициентЗагрузки()
	
	// Получаем текущую загрузку очереди
	СтатистикаОчереди = МодульОчередей.ПолучитьСтатистикуОчереди();
	
	Если СтатистикаОчереди.ВОжидании > 100 Тогда
		Возврат 1.1; // Высокая загрузка +10%
	ИначеЕсли СтатистикаОчереди.ВОжидании < 10 Тогда
		Возврат 0.9; // Низкая загрузка -10%
	Иначе
		Возврат 1.0; // Нормальная загрузка
	КонецЕсли;
	
КонецФункции

// Получить активные модификаторы
//
Функция ПолучитьАктивныеМодификаторы(Поставщик)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	МодификаторыКомиссии.Наименование КАК Наименование,
	|	МодификаторыКомиссии.Тип КАК Тип,
	|	МодификаторыКомиссии.Значение КАК Значение,
	|	МодификаторыКомиссии.Условие КАК Условие
	|ИЗ
	|	РегистрСведений.МодификаторыКомиссии КАК МодификаторыКомиссии
	|ГДЕ
	|	МодификаторыКомиссии.Поставщик = &Поставщик
	|	И МодификаторыКомиссии.Активен = ИСТИНА
	|	И (МодификаторыКомиссии.ДатаНачала <= &ТекущаяДата
	|		И (МодификаторыКомиссии.ДатаОкончания >= &ТекущаяДата
	|			ИЛИ МодификаторыКомиссии.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1)))";
	
	Запрос.УстановитьПараметр("Поставщик", Поставщик);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Проверить условия модификатора
//
Функция ПроверитьУсловияМодификатора(Модификатор, ДанныеЗаказа)
	
	// Если условий нет - применяем всегда
	Если ПустаяСтрока(Модификатор.Условие) Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Парсим условие (например: "Цена > 10000")
	// В продакшн это должно быть более надежное решение
	
	Возврат Истина;
	
КонецФункции

// Валидировать результат расчета
//
Процедура ВалидироватьРезультатРасчета(РезультатРасчета)
	
	Если РезультатРасчета.Комиссия < 0 Тогда
		ВызватьИсключение "Комиссия не может быть отрицательной";
	КонецЕсли;
	
	Если РезультатРасчета.Комиссия > 1000000 Тогда
		ВызватьИсключение "Подозрительно большая комиссия: " + РезультатРасчета.Комиссия;
	КонецЕсли;
	
КонецПроцедуры

// Записать лог расчета
//
Процедура ЗаписатьЛогРасчета(ДанныеЗаказа, Поставщик, Стратегия, РезультатРасчета)
	
	Лог = СтрШаблон(
		"Расчет комиссии: Заказ=%1, Поставщик=%2, Стратегия=%3, Комиссия=%4",
		ДанныеЗаказа.orderId,
		Поставщик.Наименование,
		Стратегия,
		РезультатРасчета.Комиссия);
	
	ЗаписатьЛог("Отладка", Лог);
	
	// Записываем в регистр для аналитики
	МенеджерЗаписи = РегистрыСведений.ИсторияРасчетаКомиссий.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Период = ТекущаяДатаСеанса();
	МенеджерЗаписи.Заказ = ДанныеЗаказа.orderId;
	МенеджерЗаписи.Поставщик = Поставщик;
	МенеджерЗаписи.Стратегия = Стратегия;
	МенеджерЗаписи.Комиссия = РезультатРасчета.Комиссия;
	МенеджерЗаписи.Детали = Новый ХранилищеЗначения(РезультатРасчета);
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

#КонецОбласти

// ====================================================================
// АРХИТЕКТУРНЫЕ РЕШЕНИЯ:
// 
// 1. Strategy Pattern - разные алгоритмы расчета взаимозаменяемы
// 2. Factory Pattern - создание калькулятора по типу стратегии
// 3. Chain of Responsibility - цепочка модификаторов
// 4. Open/Closed Principle - легко добавить новую стратегию
// 5. Single Responsibility - каждая стратегия решает одну задачу
// 6. Dependency Inversion - зависимость от абстракции, а не реализации
// 
// РАСШИРЯЕМОСТЬ:
// - Добавление новой стратегии без изменения существующего кода
// - Комбинирование модификаторов (скидки, бонусы, наценки)
// - Динамические параметры (сезонность, загрузка)
// - Условное применение модификаторов
// - История расчетов для аналитики
// 
// ИСПОЛЬЗОВАНИЕ:
// Результат = МодульСтратегий.РассчитатьКомиссию(ДанныеЗаказа, Поставщик);
// Комиссия = Результат.Комиссия; // Итоговая комиссия
// ТипРасчета = Результат.ТипРасчета; // "Ступенчатая"
// Детали = Результат.Детали; // Подробности расчета
// ====================================================================

