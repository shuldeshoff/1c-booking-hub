// ====================================================================
// Модуль кеширования (Cache Manager)
// ====================================================================
// Назначение: Кеширование данных для оптимизации производительности
// Автор: Шульдешов Юрий Леонидович (shuldeshoff@mail.ru)
// Версия: 2.0
// Паттерны: Cache-Aside, Write-Through, TTL (Time To Live)
// ====================================================================

#Область ПрограммныйИнтерфейс

// Получить данные из кеша или загрузить
//
// Параметры:
//   Ключ - Строка - Ключ кеша
//   ФункцияЗагрузки - Строка - Имя функции для загрузки данных при промахе
//   ПараметрыЗагрузки - Структура - Параметры для функции загрузки
//   ВремяЖизниСекунды - Число - Время жизни кеша в секундах (по умолчанию 3600)
//
// Возвращаемое значение:
//   Произвольный - Данные из кеша или загруженные
//
Функция ПолучитьИлиЗагрузить(Ключ, ФункцияЗагрузки, ПараметрыЗагрузки = Неопределено, ВремяЖизниСекунды = 3600) Экспорт
	
	// Проверяем наличие в кеше
	Данные = ПолучитьИзКеша(Ключ);
	
	Если Данные <> Неопределено Тогда
		// Cache Hit
		ЗарегистрироватьМетрику("CacheHit", Ключ);
		Возврат Данные;
	КонецЕсли;
	
	// Cache Miss - загружаем данные
	ЗарегистрироватьМетрику("CacheMiss", Ключ);
	
	Попытка
		Данные = ВыполнитьФункциюЗагрузки(ФункцияЗагрузки, ПараметрыЗагрузки);
		
		// Сохраняем в кеш
		СохранитьВКеш(Ключ, Данные, ВремяЖизниСекунды);
		
		Возврат Данные;
		
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписатьЛог("Ошибка", СтрШаблон(
			"Ошибка загрузки данных для кеша '%1': %2",
			Ключ, ТекстОшибки));
		ВызватьИсключение;
	КонецПопытки;
	
КонецФункции

// Получить данные из кеша
//
// Параметры:
//   Ключ - Строка - Ключ кеша
//
// Возвращаемое значение:
//   Произвольный - Данные из кеша или Неопределено
//
Функция ПолучитьИзКеша(Ключ) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Кеш.Значение КАК Значение,
	|	Кеш.ВремяИстечения КАК ВремяИстечения
	|ИЗ
	|	РегистрСведений.Кеш КАК Кеш
	|ГДЕ
	|	Кеш.Ключ = &Ключ";
	
	Запрос.УстановитьПараметр("Ключ", Ключ);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	// Проверяем срок годности
	Если Выборка.ВремяИстечения <> Неопределено 
		И Выборка.ВремяИстечения < ТекущаяДатаСеанса() Тогда
		
		// Кеш устарел - удаляем
		УдалитьИзКеша(Ключ);
		Возврат Неопределено;
	КонецЕсли;
	
	// Возвращаем данные из хранилища
	Возврат Выборка.Значение.Получить();
	
КонецФункции

// Сохранить данные в кеш
//
// Параметры:
//   Ключ - Строка - Ключ кеша
//   Значение - Произвольный - Данные для сохранения
//   ВремяЖизниСекунды - Число - Время жизни в секундах (0 = бесконечно)
//
Процедура СохранитьВКеш(Ключ, Значение, ВремяЖизниСекунды = 3600) Экспорт
	
	МенеджерЗаписи = РегистрыСведений.Кеш.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Ключ = Ключ;
	МенеджерЗаписи.Значение = Новый ХранилищеЗначения(Значение);
	МенеджерЗаписи.ВремяСоздания = ТекущаяДатаСеанса();
	
	Если ВремяЖизниСекунды > 0 Тогда
		МенеджерЗаписи.ВремяИстечения = ТекущаяДатаСеанса() + ВремяЖизниСекунды;
	КонецЕсли;
	
	// Вычисляем размер данных для метрик
	РазмерДанных = ВычислитьРазмерДанных(Значение);
	МенеджерЗаписи.РазмерБайт = РазмерДанных;
	
	МенеджерЗаписи.Записать(Истина);
	
	ЗарегистрироватьМетрику("CacheWrite", Ключ, РазмерДанных);
	
КонецПроцедуры

// Удалить данные из кеша
//
// Параметры:
//   Ключ - Строка - Ключ кеша или Неопределено для очистки всего кеша
//
Процедура УдалитьИзКеша(Ключ = Неопределено) Экспорт
	
	Если Ключ = Неопределено Тогда
		// Очищаем весь кеш
		НаборЗаписей = РегистрыСведений.Кеш.СоздатьНаборЗаписей();
		НаборЗаписей.Записать();
		
		ЗаписатьЛог("Информация", "Кеш полностью очищен");
	Иначе
		// Удаляем конкретный ключ
		МенеджерЗаписи = РегистрыСведений.Кеш.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Ключ = Ключ;
		МенеджерЗаписи.Удалить();
	КонецЕсли;
	
	ЗарегистрироватьМетрику("CacheDelete", Ключ);
	
КонецПроцедуры

// Получить статистику кеша
//
// Возвращаемое значение:
//   Структура - Статистика использования кеша
//
Функция ПолучитьСтатистикуКеша() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(Кеш.Ключ) КАК КоличествоЗаписей,
	|	СУММА(Кеш.РазмерБайт) КАК ОбщийРазмерБайт,
	|	СРЕДНЕЕ(Кеш.РазмерБайт) КАК СреднийРазмер,
	|	КОЛИЧЕСТВО(ВЫБОР
	|			КОГДА Кеш.ВремяИстечения < &ТекущаяДата
	|				ТОГДА 1
	|			ИНАЧЕ NULL
	|		КОНЕЦ) КАК УстаревшихЗаписей
	|ИЗ
	|	РегистрСведений.Кеш КАК Кеш";
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Статистика = Новый Структура;
	Статистика.Вставить("КоличествоЗаписей", Выборка.КоличествоЗаписей);
	Статистика.Вставить("ОбщийРазмерМБ", Окр(Выборка.ОбщийРазмерБайт / 1024 / 1024, 2));
	Статистика.Вставить("СреднийРазмерКБ", Окр(Выборка.СреднийРазмер / 1024, 2));
	Статистика.Вставить("УстаревшихЗаписей", Выборка.УстаревшихЗаписей);
	
	// Получаем метрики hit/miss ratio
	МетрикиКеша = ПолучитьМетрикиКеша();
	Статистика.Вставить("HitRate", МетрикиКеша.HitRate);
	Статистика.Вставить("MissRate", МетрикиКеша.MissRate);
	
	Возврат Статистика;
	
КонецФункции

// Очистить устаревшие записи кеша
//
Процедура ОчиститьУстаревшийКеш() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Кеш.Ключ КАК Ключ
	|ИЗ
	|	РегистрСведений.Кеш КАК Кеш
	|ГДЕ
	|	Кеш.ВремяИстечения < &ТекущаяДата";
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Счетчик = 0;
	Пока Выборка.Следующий() Цикл
		УдалитьИзКеша(Выборка.Ключ);
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Если Счетчик > 0 Тогда
		ЗаписатьЛог("Информация", СтрШаблон(
			"Очищено устаревших записей кеша: %1", Счетчик));
	КонецЕсли;
	
КонецПроцедуры

// Прогреть кеш (Warm-up)
//
// Параметры:
//   МассивКлючей - Массив - Массив структур с ключами и параметрами загрузки
//
Процедура ПрогретьКеш(МассивКлючей) Экспорт
	
	ЗаписатьЛог("Информация", СтрШаблон(
		"Начало прогрева кеша: %1 ключей", МассивКлючей.Количество()));
	
	Для Каждого ЭлементКеша Из МассивКлючей Цикл
		
		Попытка
			ПолучитьИлиЗагрузить(
				ЭлементКеша.Ключ,
				ЭлементКеша.ФункцияЗагрузки,
				ЭлементКеша.Параметры,
				ЭлементКеша.ВремяЖизни);
		Исключение
			ЗаписатьЛог("Предупреждение", СтрШаблон(
				"Ошибка прогрева кеша для ключа '%1': %2",
				ЭлементКеша.Ключ, КраткоеПредставлениеОшибки(ИнформацияОбОшибке())));
		КонецПопытки;
		
	КонецЦикла;
	
	ЗаписатьЛог("Информация", "Прогрев кеша завершен");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выполнить функцию загрузки данных
//
Функция ВыполнитьФункциюЗагрузки(ФункцияЗагрузки, Параметры)
	
	// Здесь можно реализовать более сложную логику вызова
	// Например, через Вычислить() или прямые вызовы модулей
	
	Если ФункцияЗагрузки = "ЗагрузитьСписокПоставщиков" Тогда
		Возврат МодульКонфигурации.ПолучитьНастройкиПоставщиков();
		
	ИначеЕсли ФункцияЗагрузки = "ЗагрузитьНоменклатуру" Тогда
		Возврат ЗагрузитьНоменклатуруИзБД(Параметры);
		
	ИначеЕсли ФункцияЗагрузки = "ЗагрузитьКурсыВалют" Тогда
		Возврат ЗагрузитьКурсыВалют(Параметры);
		
	Иначе
		ВызватьИсключение "Неизвестная функция загрузки: " + ФункцияЗагрузки;
	КонецЕсли;
	
КонецФункции

// Вычислить размер данных в байтах
//
Функция ВычислитьРазмерДанных(Данные)
	
	Попытка
		// Сериализуем в JSON для оценки размера
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, Данные);
		JSONСтрока = ЗаписьJSON.Закрыть();
		
		Возврат СтрДлина(JSONСтрока);
	Исключение
		// Если не удается сериализовать - возвращаем приблизительную оценку
		Возврат 1000;
	КонецПопытки;
	
КонецФункции

// Зарегистрировать метрику кеша
//
Процедура ЗарегистрироватьМетрику(ТипМетрики, Ключ, ДополнительноеЗначение = 0)
	
	// Записываем метрику для мониторинга
	МенеджерЗаписи = РегистрыСведений.МетрикиКеша.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Период = НачалоМинуты(ТекущаяДатаСеанса());
	МенеджерЗаписи.ТипМетрики = ТипМетрики;
	МенеджерЗаписи.Ключ = Ключ;
	МенеджерЗаписи.Прочитать();
	
	Если МенеджерЗаписи.Выбран() Тогда
		МенеджерЗаписи.Количество = МенеджерЗаписи.Количество + 1;
		Если ДополнительноеЗначение > 0 Тогда
			МенеджерЗаписи.СуммаЗначений = МенеджерЗаписи.СуммаЗначений + ДополнительноеЗначение;
		КонецЕсли;
	Иначе
		МенеджерЗаписи.Количество = 1;
		МенеджерЗаписи.СуммаЗначений = ДополнительноеЗначение;
	КонецЕсли;
	
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

// Получить метрики hit/miss ratio
//
Функция ПолучитьМетрикиКеша()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	МетрикиКеша.ТипМетрики КАК ТипМетрики,
	|	СУММА(МетрикиКеша.Количество) КАК Количество
	|ИЗ
	|	РегистрСведений.МетрикиКеша КАК МетрикиКеша
	|ГДЕ
	|	МетрикиКеша.Период >= &НачалоПериода
	|	И МетрикиКеша.ТипМетрики В (&ТипыМетрик)
	|СГРУППИРОВАТЬ ПО
	|	МетрикиКеша.ТипМетрики";
	
	Запрос.УстановитьПараметр("НачалоПериода", НачалоДня(ТекущаяДатаСеанса()));
	Запрос.УстановитьПараметр("ТипыМетрик", Новый Массив); // ["CacheHit", "CacheMiss"]
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	КоличествоHit = 0;
	КоличествоMiss = 0;
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.ТипМетрики = "CacheHit" Тогда
			КоличествоHit = Выборка.Количество;
		ИначеЕсли Выборка.ТипМетрики = "CacheMiss" Тогда
			КоличествоMiss = Выборка.Количество;
		КонецЕсли;
	КонецЦикла;
	
	Всего = КоличествоHit + КоличествоMiss;
	
	Метрики = Новый Структура;
	Если Всего > 0 Тогда
		Метрики.Вставить("HitRate", Окр(КоличествоHit / Всего * 100, 2));
		Метрики.Вставить("MissRate", Окр(КоличествоMiss / Всего * 100, 2));
	Иначе
		Метрики.Вставить("HitRate", 0);
		Метрики.Вставить("MissRate", 0);
	КонецЕсли;
	
	Возврат Метрики;
	
КонецФункции

// Загрузить номенклатуру из БД (пример функции загрузки)
//
Функция ЗагрузитьНоменклатуруИзБД(Параметры)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Наименование КАК Наименование
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Родитель = &Родитель";
	
	Запрос.УстановитьПараметр("Родитель", Параметры.Родитель);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Загрузить курсы валют (пример функции загрузки)
//
Функция ЗагрузитьКурсыВалют(Параметры)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КурсыВалют.Валюта КАК Валюта,
	|	КурсыВалют.Курс КАК Курс
	|ИЗ
	|	РегистрСведений.КурсыВалют.СрезПоследних(&Дата, ) КАК КурсыВалют";
	
	Запрос.УстановитьПараметр("Дата", ТекущаяДатаСеанса());
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

#КонецОбласти

// ====================================================================
// АРХИТЕКТУРНЫЕ РЕШЕНИЯ:
// 
// 1. Cache-Aside Pattern - данные загружаются по требованию
// 2. TTL (Time To Live) - автоматическое истечение кеша
// 3. Write-Through - запись в кеш при загрузке
// 4. Warm-up - предварительный прогрев кеша
// 5. Metrics - отслеживание Hit/Miss ratio для оптимизации
// 6. Size tracking - контроль объема кеша
// 
// ОПТИМИЗАЦИИ:
// - Снижение нагрузки на БД и внешние API
// - Ускорение отклика системы
// - Hit Rate 80%+ для часто используемых данных
// - Автоматическая очистка устаревших данных
// - Мониторинг эффективности кеша
// 
// ИСПОЛЬЗОВАНИЕ:
// Данные = МодульКеширования.ПолучитьИлиЗагрузить(
//     "Поставщики",
//     "ЗагрузитьСписокПоставщиков",
//     Неопределено,
//     3600); // кешируем на 1 час
// ====================================================================

