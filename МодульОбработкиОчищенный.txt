// ====================================================================
// Модуль внешней обработки "Интеграция с системами бронирования"
// ====================================================================
// Назначение: Загрузка заказов из API систем бронирования отелей
// Архитектура: Модульная с разделением ответственности
// Автор: Шульдешов Юрий Леонидович (shuldeshoff@mail.ru)
// Версия: 2.0
// ====================================================================

#Область ПрограммныйИнтерфейс

// Функция для регистрации внешней обработки
//
// Возвращаемое значение:
//   Структура - Параметры регистрации обработки
//
Функция СведенияОВнешнейОбработке() Экспорт
	
	ПараметрыРегистрации = Новый Структура;
	ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");
	ПараметрыРегистрации.Вставить("Назначение", ПолучитьНазначениеОбработки());
	ПараметрыРегистрации.Вставить("Наименование", НСтр("ru = 'Интеграция с API бронирования'"));
	ПараметрыРегистрации.Вставить("Версия", "2.0");
	ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);
	ПараметрыРегистрации.Вставить("Информация", НСтр("ru = 'Загрузка заказов из систем бронирования через REST API'"));
	
	ТаблицаКоманд = ПолучитьТаблицуКоманд();
	
	ДобавитьКоманду(ТаблицаКоманд,
		НСтр("ru = 'Загрузить заказы из API'"),
		"ЗагрузитьЗаказыИзAPI",
		"ВызовСерверногоМетода",
		Истина,
		"Загрузка и обработка заказов");
	
	ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
	
	Возврат ПараметрыРегистрации;
	
КонецФункции

// Выполнить команду обработки
//
// Параметры:
//   Команда - Строка - Идентификатор команды для выполнения
//
Процедура ВыполнитьКоманду(Команда) Экспорт
	
	Если Команда = "ЗагрузитьЗаказыИзAPI" Тогда
		ЗагрузитьЗаказыИзAPI();
	Иначе
		ВызватьИсключение НСтр("ru = 'Команда не найдена: '") + Команда;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОсновнаяЛогика

// Основная процедура загрузки заказов из API
//
&НаСервере
Процедура ЗагрузитьЗаказыИзAPI()
	
	// Получаем настройки из модуля конфигурации
	НастройкиПодключения = МодульКонфигурации.ПолучитьНастройкиПодключения();
	УчетныеДанные = МодульКонфигурации.ПолучитьУчетныеДанные();
	
	// Параметры периода загрузки
	НачалоПериода = НачалоДня(ТекущаяДата());
	КонецПериода = КонецДня(ТекущаяДата());
	
	// Валидация параметров
	Если КонецПериода <= НачалоПериода Тогда
		ВызватьИсключение НСтр("ru = 'Некорректный период загрузки данных'");
	КонецЕсли;
	
	ЗаписатьЛог("Информация", "Начало загрузки заказов за период: " 
		+ Формат(НачалоПериода, "ДЛФ=D") + " - " + Формат(КонецПериода, "ДЛФ=D"));
	
	Попытка
		// 1. Получаем токен авторизации
		Токен = ПолучитьТокенАвторизации(НастройкиПодключения, УчетныеДанные);
		
		// 2. Загружаем список заказов
		МассивЗаказов = ЗагрузитьСписокЗаказов(НастройкиПодключения, Токен, НачалоПериода, КонецПериода);
		
		// 3. Обрабатываем каждый заказ
		ОбработатьЗаказы(МассивЗаказов);
		
		ЗаписатьЛог("Информация", "Загрузка завершена успешно. Обработано заказов: " + МассивЗаказов.Количество());
		
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписатьЛог("Ошибка", "Ошибка при загрузке заказов: " + ТекстОшибки);
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСAPI

// Получить токен авторизации от API
//
// Параметры:
//   НастройкиПодключения - Структура - Параметры подключения
//   УчетныеДанные - Структура - Логин и пароль
//
// Возвращаемое значение:
//   Строка - Bearer токен для авторизации
//
&НаСервере
Функция ПолучитьТокенАвторизации(НастройкиПодключения, УчетныеДанные)
	
	// Формируем тело запроса
	ДанныеАвторизации = Новый Структура;
	ДанныеАвторизации.Вставить("username", УчетныеДанные.Логин);
	ДанныеАвторизации.Вставить("password", УчетныеДанные.Пароль);
	
	JSONСтрока = СериализоватьВJSON(ДанныеАвторизации);
	
	// Создаем HTTP запрос
	HTTPЗапрос = Новый HTTPЗапрос("/v1/auth/token");
	HTTPЗапрос.УстановитьТелоИзСтроки(JSONСтрока);
	HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
	
	// Выполняем запрос
	HTTPСоединение = СоздатьHTTPСоединение(НастройкиПодключения.URLСервера);
	Ответ = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
	
	// Проверяем код ответа
	Если Ответ.КодСостояния <> 200 Тогда
		ВызватьИсключение СтрШаблон(
			НСтр("ru = 'Ошибка авторизации. Код: %1, Сообщение: %2'"),
			Ответ.КодСостояния,
			Ответ.ПолучитьТелоКакСтроку());
	КонецЕсли;
	
	// Парсим ответ
	ДанныеОтвета = ДесериализоватьИзJSON(Ответ.ПолучитьТелоКакСтроку());
	
	Возврат ДанныеОтвета.access_token;
	
КонецФункции

// Загрузить список заказов из API с пагинацией
//
// Параметры:
//   НастройкиПодключения - Структура - Параметры подключения
//   Токен - Строка - Токен авторизации
//   НачалоПериода - Дата - Начало периода выборки
//   КонецПериода - Дата - Конец периода выборки
//
// Возвращаемое значение:
//   Массив - Массив структур с данными заказов
//
&НаСервере
Функция ЗагрузитьСписокЗаказов(НастройкиПодключения, Токен, НачалоПериода, КонецПериода)
	
	МассивЗаказов = Новый Массив;
	
	// Получаем список активных поставщиков
	СписокПоставщиков = ПолучитьСписокАктивныхПоставщиков();
	
	Для Каждого Поставщик Из СписокПоставщиков Цикл
		
		ЗаписатьЛог("Информация", "Загрузка заказов от поставщика: " + Поставщик.Наименование);
		
		// Параметры запроса
		ПараметрыЗапроса = Новый Структура;
		ПараметрыЗапроса.Вставить("start_date", Формат(НачалоПериода, "ДФ=yyyy-MM-dd"));
		ПараметрыЗапроса.Вставить("end_date", Формат(КонецПериода, "ДФ=yyyy-MM-dd"));
		ПараметрыЗапроса.Вставить("service_name", Поставщик.ИдентификаторВAPI);
		ПараметрыЗапроса.Вставить("limit", НастройкиПодключения.РазмерСтраницы);
		
		// Загружаем с пагинацией
		Страница = 0;
		ЕстьДанные = Истина;
		
		Пока ЕстьДанные Цикл
			
			ПараметрыЗапроса.Вставить("offset", Страница * НастройкиПодключения.РазмерСтраницы);
			
			// Формируем URL с параметрами
			URLЗапроса = СформироватьURLСПараметрами("/v1/orders/", ПараметрыЗапроса);
			
			HTTPЗапрос = Новый HTTPЗапрос(URLЗапроса);
			HTTPЗапрос.Заголовки.Вставить("Authorization", "Bearer " + Токен);
			HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
			
			HTTPСоединение = СоздатьHTTPСоединение(НастройкиПодключения.URLСервера);
			Ответ = HTTPСоединение.Получить(HTTPЗапрос);
			
			Если Ответ.КодСостояния = 200 Тогда
				
				ДанныеОтвета = ДесериализоватьИзJSON(Ответ.ПолучитьТелоКакСтроку());
				
				Если ДанныеОтвета.Свойство("orders") И ДанныеОтвета.orders.Количество() > 0 Тогда
					
					// Добавляем заказы в массив
					Для Каждого Заказ Из ДанныеОтвета.orders Цикл
						// Добавляем информацию о поставщике
						Заказ.Вставить("_Поставщик", Поставщик);
						МассивЗаказов.Добавить(Заказ);
					КонецЦикла;
					
					Страница = Страница + 1;
					
				Иначе
					ЕстьДанные = Ложь;
				КонецЕсли;
				
			Иначе
				ЗаписатьЛог("Предупреждение", СтрШаблон(
					"Ошибка при загрузке страницы %1: код %2",
					Страница, Ответ.КодСостояния));
				ЕстьДанные = Ложь;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат МассивЗаказов;
	
КонецФункции

#КонецОбласти

#Область ОбработкаДанных

// Обработать массив заказов
//
// Параметры:
//   МассивЗаказов - Массив - Заказы для обработки
//
&НаСервере
Процедура ОбработатьЗаказы(МассивЗаказов)
	
	Для Каждого ДанныеЗаказа Из МассивЗаказов Цикл
		
		Попытка
			// Обработка в транзакции
			НачатьТранзакцию();
			
			Попытка
				ОбработатьОдинЗаказ(ДанныеЗаказа);
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				ВызватьИсключение;
			КонецПопытки;
			
		Исключение
			ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЗаписатьЛог("Ошибка", СтрШаблон(
				"Ошибка при обработке заказа №%1: %2",
				ДанныеЗаказа.orderId, ТекстОшибки));
			// Продолжаем обработку следующих заказов
			Продолжить;
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

// Обработать один заказ (создать цепочку документов)
//
// Параметры:
//   ДанныеЗаказа - Структура - Данные заказа из API
//
&НаСервере
Процедура ОбработатьОдинЗаказ(ДанныеЗаказа)
	
	// 1. Создаем/находим номенклатуру
	Номенклатура = СоздатьИлиНайтиНоменклатуру(ДанныеЗаказа);
	
	// 2. Устанавливаем цену
	УстановитьЦенуНоменклатуры(Номенклатура, ДанныеЗаказа);
	
	// 3. Создаем счет от поставщика
	СчетОтПоставщика = СоздатьСчетОтПоставщика(Номенклатура, ДанныеЗаказа);
	
	// 4. Создаем поступление
	Поступление = СоздатьПоступление(Номенклатура, ДанныеЗаказа, СчетОтПоставщика);
	
	// 5. Если оплата на сайте - создаем документы продажи
	Если ДанныеЗаказа.rooms[0].paymentRecipient = "agency" Тогда
		СчетПокупателю = СоздатьСчетПокупателю(Номенклатура, ДанныеЗаказа);
		Реализация = СоздатьРеализацию(Номенклатура, ДанныеЗаказа, СчетПокупателю);
	КонецЕсли;
	
	ЗаписатьЛог("Информация", СтрШаблон(
		"Заказ №%1 успешно обработан",
		ДанныеЗаказа.orderId));
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеФункции

// Создать HTTP соединение с защитой
//
// Параметры:
//   Сервер - Строка - Адрес сервера
//
// Возвращаемое значение:
//   HTTPСоединение
//
Функция СоздатьHTTPСоединение(Сервер)
	
	ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL();
	HTTPСоединение = Новый HTTPСоединение(Сервер, , , , , , ЗащищенноеСоединение);
	
	Возврат HTTPСоединение;
	
КонецФункции

// Сформировать URL с параметрами запроса
//
// Параметры:
//   БазовыйURL - Строка - Базовый путь
//   Параметры - Структура - Параметры запроса
//
// Возвращаемое значение:
//   Строка - Полный URL с параметрами
//
Функция СформироватьURLСПараметрами(БазовыйURL, Параметры)
	
	СтрокаПараметров = "";
	
	Для Каждого Параметр Из Параметры Цикл
		Если НЕ ПустаяСтрока(СтрокаПараметров) Тогда
			СтрокаПараметров = СтрокаПараметров + "&";
		КонецЕсли;
		СтрокаПараметров = СтрокаПараметров + Параметр.Ключ + "=" + КодироватьСтроку(Строка(Параметр.Значение), СпособКодированияСтроки.КодировкаURL);
	КонецЦикла;
	
	Возврат БазовыйURL + "?" + СтрокаПараметров;
	
КонецФункции

// Сериализовать структуру в JSON
//
// Параметры:
//   Данные - Произвольный - Данные для сериализации
//
// Возвращаемое значение:
//   Строка - JSON строка
//
Функция СериализоватьВJSON(Данные)
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Данные);
	
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции

// Десериализовать JSON строку
//
// Параметры:
//   JSONСтрока - Строка - JSON для парсинга
//
// Возвращаемое значение:
//   Произвольный - Десериализованные данные
//
Функция ДесериализоватьИзJSON(JSONСтрока)
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(JSONСтрока);
	Результат = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	Возврат Результат;
	
КонецФункции

// Записать сообщение в лог
//
// Параметры:
//   Уровень - Строка - Уровень сообщения (Информация, Предупреждение, Ошибка)
//   Текст - Строка - Текст сообщения
//
Процедура ЗаписатьЛог(Уровень, Текст)
	
	// В реальном проекте: запись в журнал регистрации или отдельный лог
	Сообщить(СтрШаблон("[%1] %2: %3", ТекущаяДата(), Уровень, Текст));
	
КонецПроцедуры

#КонецОбласти

// ====================================================================
// ПРИМЕЧАНИЯ ДЛЯ РАЗРАБОТЧИКОВ:
// 
// 1. Модуль разделен на логические области с четкой ответственностью
// 2. Все конфигурационные данные вынесены в модуль конфигурации
// 3. Обработка ошибок на каждом уровне с транзакциями
// 4. Логирование всех ключевых операций
// 5. Пагинация для работы с большими объемами данных
// 6. Масштабируемость - легко добавить новых поставщиков
// 7. Тестируемость - каждая функция имеет одну ответственность
// 
// РЕКОМЕНДАЦИИ ПО РАЗВИТИЮ:
// - Рассмотреть стратегию обработки ошибок (продолжать или останавливать?)
// - Оптимизация запросов к базе данных
// - Асинхронная обработка больших объемов
// - Мониторинг и алертинг при сбоях
// ====================================================================

