// ====================================================================
// Модуль мониторинга и метрик (Monitoring & Metrics)
// ====================================================================
// Назначение: Сбор метрик производительности и мониторинг системы
// Автор: Шульдешов Юрий Леонидович (shuldeshoff@mail.ru)
// Версия: 2.0
// Паттерны: Observer, Event Sourcing, Time Series Data
// ====================================================================

#Область ПрограммныйИнтерфейс

// Зарегистрировать метрику
//
// Параметры:
//   ИмяМетрики - Строка - Название метрики
//   Значение - Число - Значение метрики
//   Теги - Соответствие - Дополнительные теги для группировки
//
Процедура ЗарегистрироватьМетрику(ИмяМетрики, Значение, Теги = Неопределено) Экспорт
	
	МенеджерЗаписи = РегистрыСведений.Метрики.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Период = ТекущаяДатаСеанса();
	МенеджерЗаписи.ИмяМетрики = ИмяМетрики;
	МенеджерЗаписи.Значение = Значение;
	
	Если Теги <> Неопределено Тогда
		МенеджерЗаписи.Теги = Новый ХранилищеЗначения(Теги);
	КонецЕсли;
	
	МенеджерЗаписи.Записать();
	
	// Проверяем пороговые значения для алертов
	ПроверитьПороговыеЗначения(ИмяМетрики, Значение);
	
КонецПроцедуры

// Замерить время выполнения операции
//
// Параметры:
//   ИмяОперации - Строка - Название операции
//   ФункцияВыполнения - Строка - Имя функции для выполнения
//   Параметры - Структура - Параметры функции
//
// Возвращаемое значение:
//   Структура - Результат выполнения и метрики
//
Функция ЗамеритьВремяВыполнения(ИмяОперации, ФункцияВыполнения, Параметры = Неопределено) Экспорт
	
	ВремяНачала = ТекущаяУниверсальнаяДатаВМиллисекундах();
	УИДОперации = Новый УникальныйИдентификатор;
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("ДанныеРезультата", Неопределено);
	Результат.Вставить("ВремяВыполненияМС", 0);
	Результат.Вставить("ТекстОшибки", "");
	Результат.Вставить("УИДОперации", УИДОперации);
	
	Попытка
		// Записываем начало операции
		ЗаписатьСобытиеОперации(УИДОперации, ИмяОперации, "Начало", Параметры);
		
		// Выполняем операцию
		РезультатВыполнения = ВыполнитьОперацию(ФункцияВыполнения, Параметры);
		
		Результат.Успех = Истина;
		Результат.ДанныеРезультата = РезультатВыполнения;
		
	Исключение
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	ВремяОкончания = ТекущаяУниверсальнаяДатаВМиллисекундах();
	Результат.ВремяВыполненияМС = ВремяОкончания - ВремяНачала;
	
	// Записываем метрики
	Теги = Новый Соответствие;
	Теги.Вставить("операция", ИмяОперации);
	Теги.Вставить("успех", Результат.Успех);
	
	ЗарегистрироватьМетрику("ВремяВыполнения", Результат.ВремяВыполненияМС, Теги);
	
	// Записываем завершение операции
	СтатусОперации = ?(Результат.Успех, "Успех", "Ошибка");
	ЗаписатьСобытиеОперации(УИДОперации, ИмяОперации, СтатусОперации, Результат);
	
	Возврат Результат;
	
КонецФункции

// Получить метрики за период
//
// Параметры:
//   ИмяМетрики - Строка - Название метрики (или пустая строка для всех)
//   НачалоПериода - Дата - Начало периода
//   КонецПериода - Дата - Конец периода
//   ТипАгрегации - Строка - Тип агрегации (Среднее, Сумма, Минимум, Максимум, Количество)
//
// Возвращаемое значение:
//   ТаблицаЗначений - Метрики с агрегацией
//
Функция ПолучитьМетрики(ИмяМетрики = "", НачалоПериода = Неопределено, КонецПериода = Неопределено, ТипАгрегации = "Среднее") Экспорт
	
	Если НачалоПериода = Неопределено Тогда
		НачалоПериода = НачалоДня(ТекущаяДатаСеанса());
	КонецЕсли;
	
	Если КонецПериода = Неопределено Тогда
		КонецПериода = КонецДня(ТекущаяДатаСеанса());
	КонецЕсли;
	
	ФункцияАгрегации = ПолучитьФункциюАгрегации(ТипАгрегации);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Метрики.ИмяМетрики КАК ИмяМетрики,
	|	&ФункцияАгрегации(Метрики.Значение) КАК ЗначениеАгрегации,
	|	КОЛИЧЕСТВО(Метрики.Период) КАК КоличествоЗаписей,
	|	МИНИМУМ(Метрики.Значение) КАК МинЗначение,
	|	МАКСИМУМ(Метрики.Значение) КАК МаксЗначение
	|ИЗ
	|	РегистрСведений.Метрики КАК Метрики
	|ГДЕ
	|	Метрики.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	&УсловиеИмени
	|СГРУППИРОВАТЬ ПО
	|	Метрики.ИмяМетрики";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ФункцияАгрегации", ФункцияАгрегации);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
	
	Если ПустаяСтрока(ИмяМетрики) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеИмени", "");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеИмени", "И Метрики.ИмяМетрики = &ИмяМетрики");
		Запрос.УстановитьПараметр("ИмяМетрики", ИмяМетрики);
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Получить dashboard с основными метриками
//
// Возвращаемое значение:
//   Структура - Дашборд с ключевыми показателями
//
Функция ПолучитьDashboard() Экспорт
	
	Dashboard = Новый Структура;
	
	// Метрики очереди
	СтатистикаОчереди = МодульОчередей.ПолучитьСтатистикуОчереди();
	Dashboard.Вставить("Очередь", СтатистикаОчереди);
	
	// Метрики кеша
	СтатистикаКеша = МодульКеширования.ПолучитьСтатистикуКеша();
	Dashboard.Вставить("Кеш", СтатистикаКеша);
	
	// Метрики производительности
	МетрикиПроизводительности = Новый Структура;
	
	// Среднее время загрузки заказов
	ВремяЗагрузки = ПолучитьМетрики("ВремяВыполнения", , , "Среднее");
	Если ВремяЗагрузки.Количество() > 0 Тогда
		МетрикиПроизводительности.Вставить("СреднееВремяЗагрузкиМС", 
			ВремяЗагрузки[0].ЗначениеАгрегации);
	Иначе
		МетрикиПроизводительности.Вставить("СреднееВремяЗагрузкиМС", 0);
	КонецЕсли;
	
	// Количество обработанных заказов за сегодня
	КоличествоЗаказов = ПолучитьМетрики("ЗаказовОбработано", , , "Сумма");
	Если КоличествоЗаказов.Количество() > 0 Тогда
		МетрикиПроизводительности.Вставить("ЗаказовОбработаноСегодня", 
			КоличествоЗаказов[0].ЗначениеАгрегации);
	Иначе
		МетрикиПроизводительности.Вставить("ЗаказовОбработаноСегодня", 0);
	КонецЕсли;
	
	// Процент ошибок
	КоличествоОшибок = ПолучитьКоличествоОшибокЗаПериод();
	ВсегоОпераций = МетрикиПроизводительности.ЗаказовОбработаноСегодня;
	
	Если ВсегоОпераций > 0 Тогда
		ПроцентОшибок = Окр(КоличествоОшибок / ВсегоОпераций * 100, 2);
	Иначе
		ПроцентОшибок = 0;
	КонецЕсли;
	
	МетрикиПроизводительности.Вставить("ПроцентОшибок", ПроцентОшибок);
	
	Dashboard.Вставить("Производительность", МетрикиПроизводительности);
	
	// Метрики здоровья системы (Health Check)
	ЗдоровьеСистемы = ПроверитьЗдоровьеСистемы();
	Dashboard.Вставить("Здоровье", ЗдоровьеСистемы);
	
	Возврат Dashboard;
	
КонецФункции

// Проверить здоровье системы (Health Check)
//
// Возвращаемое значение:
//   Структура - Статус компонентов системы
//
Функция ПроверитьЗдоровьеСистемы() Экспорт
	
	Здоровье = Новый Структура;
	Здоровье.Вставить("ОбщийСтатус", "Healthy");
	Здоровье.Вставить("Компоненты", Новый Соответствие);
	
	// Проверка базы данных
	СтатусБД = ПроверитьБазуДанных();
	Здоровье.Компоненты.Вставить("БазаДанных", СтатусБД);
	
	// Проверка API
	СтатусAPI = ПроверитьДоступностьAPI();
	Здоровье.Компоненты.Вставить("API", СтатусAPI);
	
	// Проверка очереди
	СтатусОчереди = ПроверитьОчередь();
	Здоровье.Компоненты.Вставить("Очередь", СтатусОчереди);
	
	// Проверка кеша
	СтатусКеша = ПроверитьКеш();
	Здоровье.Компоненты.Вставить("Кеш", СтатусКеша);
	
	// Определяем общий статус
	Для Каждого Компонент Из Здоровье.Компоненты Цикл
		Если Компонент.Значение.Статус = "Unhealthy" Тогда
			Здоровье.ОбщийСтатус = "Unhealthy";
			Прервать;
		ИначеЕсли Компонент.Значение.Статус = "Degraded" Тогда
			Здоровье.ОбщийСтатус = "Degraded";
		КонецЕсли;
	КонецЦикла;
	
	Возврат Здоровье;
	
КонецФункции

// Получить временной ряд метрики (Time Series)
//
// Параметры:
//   ИмяМетрики - Строка - Название метрики
//   НачалоПериода - Дата
//   КонецПериода - Дата
//   Интервал - Строка - Интервал агрегации (Минута, Час, День)
//
// Возвращаемое значение:
//   ТаблицаЗначений - Временной ряд с метриками
//
Функция ПолучитьВременнойРяд(ИмяМетрики, НачалоПериода, КонецПериода, Интервал = "Час") Экспорт
	
	ФункцияГруппировки = ПолучитьФункциюГруппировкиПоВремени(Интервал);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	&ФункцияГруппировки(Метрики.Период) КАК Период,
	|	СРЕДНЕЕ(Метрики.Значение) КАК СреднееЗначение,
	|	МИНИМУМ(Метрики.Значение) КАК МинЗначение,
	|	МАКСИМУМ(Метрики.Значение) КАК МаксЗначение,
	|	КОЛИЧЕСТВО(Метрики.Период) КАК КоличествоЗаписей
	|ИЗ
	|	РегистрСведений.Метрики КАК Метрики
	|ГДЕ
	|	Метрики.ИмяМетрики = &ИмяМетрики
	|	И Метрики.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|СГРУППИРОВАТЬ ПО
	|	&ФункцияГруппировки(Метрики.Период)
	|УПОРЯДОЧИТЬ ПО
	|	Период";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ФункцияГруппировки", ФункцияГруппировки);
	Запрос.УстановитьПараметр("ИмяМетрики", ИмяМетрики);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выполнить операцию
//
Функция ВыполнитьОперацию(ФункцияВыполнения, Параметры)
	
	// Диспетчеризация операций
	Если ФункцияВыполнения = "ЗагрузитьЗаказы" Тогда
		Возврат МодульИнтеграции.ЗагрузитьЗаказыИзAPI(Параметры);
	ИначеЕсли ФункцияВыполнения = "ОбработатьЗаказ" Тогда
		Возврат МодульИнтеграции.ОбработатьОдинЗаказ(Параметры);
	Иначе
		ВызватьИсключение "Неизвестная операция: " + ФункцияВыполнения;
	КонецЕсли;
	
КонецФункции

// Записать событие операции (Event Sourcing)
//
Процедура ЗаписатьСобытиеОперации(УИДОперации, ИмяОперации, СтатусОперации, Данные)
	
	МенеджерЗаписи = РегистрыСведений.СобытияОпераций.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Период = ТекущаяДатаСеанса();
	МенеджерЗаписи.УИДОперации = УИДОперации;
	МенеджерЗаписи.ИмяОперации = ИмяОперации;
	МенеджерЗаписи.СтатусОперации = СтатусОперации;
	МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные);
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

// Проверить пороговые значения для алертов
//
Процедура ПроверитьПороговыеЗначения(ИмяМетрики, Значение)
	
	// Получаем пороговые значения из настроек
	ПороговыеЗначения = ПолучитьПороговыеЗначения(ИмяМетрики);
	
	Если ПороговыеЗначения = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОтправитьАлерт = Ложь;
	ТекстАлерта = "";
	
	Если ПороговыеЗначения.Свойство("МаксимальноеЗначение") 
		И Значение > ПороговыеЗначения.МаксимальноеЗначение Тогда
		
		ОтправитьАлерт = Истина;
		ТекстАлерта = СтрШаблон(
			"Метрика '%1' превысила максимальное значение: %2 > %3",
			ИмяМетрики, Значение, ПороговыеЗначения.МаксимальноеЗначение);
		
	ИначеЕсли ПороговыеЗначения.Свойство("МинимальноеЗначение") 
		И Значение < ПороговыеЗначения.МинимальноеЗначение Тогда
		
		ОтправитьАлерт = Истина;
		ТекстАлерта = СтрШаблон(
			"Метрика '%1' ниже минимального значения: %2 < %3",
			ИмяМетрики, Значение, ПороговыеЗначения.МинимальноеЗначение);
	КонецЕсли;
	
	Если ОтправитьАлерт Тогда
		ОтправитьАлертОператору(ТекстАлерта, "Критично");
	КонецЕсли;
	
КонецПроцедуры

// Получить пороговые значения для метрики
//
Функция ПолучитьПороговыеЗначения(ИмяМетрики)
	
	// В продакшн это должно читаться из настроек
	ПороговыеЗначения = Новый Соответствие;
	
	// Примеры пороговых значений
	Если ИмяМетрики = "ВремяВыполнения" Тогда
		Настройки = Новый Структура;
		Настройки.Вставить("МаксимальноеЗначение", 30000); // 30 секунд
		ПороговыеЗначения.Вставить(ИмяМетрики, Настройки);
		
	ИначеЕсли ИмяМетрики = "ПроцентОшибок" Тогда
		Настройки = Новый Структура;
		Настройки.Вставить("МаксимальноеЗначение", 5); // 5%
		ПороговыеЗначения.Вставить(ИмяМетрики, Настройки);
		
	ИначеЕсли ИмяМетрики = "HitRate" Тогда
		Настройки = Новый Структура;
		Настройки.Вставить("МинимальноеЗначение", 70); // 70%
		ПороговыеЗначения.Вставить(ИмяМетрики, Настройки);
	КонецЕсли;
	
	Возврат ПороговыеЗначения.Получить(ИмяМетрики);
	
КонецФункции

// Отправить алерт оператору
//
Процедура ОтправитьАлертОператору(ТекстАлерта, Уровень = "Предупреждение")
	
	// Записываем в журнал
	УровеньЖурнала = ?(Уровень = "Критично", 
		УровеньЖурналаРегистрации.Ошибка,
		УровеньЖурналаРегистрации.Предупреждение);
	
	ЗаписьЖурналаРегистрации(
		"МониторингМетрик.Алерт",
		УровеньЖурнала,
		,
		,
		ТекстАлерта);
	
	// Можно отправить в Telegram, Email, SMS и т.д.
	// Для примера - просто выводим сообщение
	Сообщить("[ALERT " + Уровень + "] " + ТекстАлерта);
	
КонецПроцедуры

// Получить функцию агрегации
//
Функция ПолучитьФункциюАгрегации(ТипАгрегации)
	
	Если ТипАгрегации = "Среднее" Тогда
		Возврат "СРЕДНЕЕ";
	ИначеЕсли ТипАгрегации = "Сумма" Тогда
		Возврат "СУММА";
	ИначеЕсли ТипАгрегации = "Минимум" Тогда
		Возврат "МИНИМУМ";
	ИначеЕсли ТипАгрегации = "Максимум" Тогда
		Возврат "МАКСИМУМ";
	ИначеЕсли ТипАгрегации = "Количество" Тогда
		Возврат "КОЛИЧЕСТВО";
	Иначе
		Возврат "СРЕДНЕЕ";
	КонецЕсли;
	
КонецФункции

// Получить функцию группировки по времени
//
Функция ПолучитьФункциюГруппировкиПоВремени(Интервал)
	
	Если Интервал = "Минута" Тогда
		Возврат "НАЧАЛОМИНУТЫ";
	ИначеЕсли Интервал = "Час" Тогда
		Возврат "НАЧАЛОЧАСА";
	ИначеЕсли Интервал = "День" Тогда
		Возврат "НАЧАЛОДНЯ";
	Иначе
		Возврат "НАЧАЛОЧАСА";
	КонецЕсли;
	
КонецФункции

// Проверить базу данных
//
Функция ПроверитьБазуДанных()
	
	Статус = Новый Структура;
	Статус.Вставить("Статус", "Healthy");
	Статус.Вставить("Сообщение", "");
	
	Попытка
		// Пробуем выполнить простой запрос
		Запрос = Новый Запрос("ВЫБРАТЬ 1");
		Запрос.Выполнить();
	Исключение
		Статус.Статус = "Unhealthy";
		Статус.Сообщение = "Ошибка подключения к БД";
	КонецПопытки;
	
	Возврат Статус;
	
КонецФункции

// Проверить доступность API
//
Функция ПроверитьДоступностьAPI()
	
	Статус = Новый Структура;
	Статус.Вставить("Статус", "Healthy");
	Статус.Вставить("Сообщение", "");
	Статус.Вставить("ВремяОткликаМС", 0);
	
	Попытка
		ВремяНачала = ТекущаяУниверсальнаяДатаВМиллисекундах();
		
		// Пробуем получить токен
		НастройкиПодключения = МодульКонфигурации.ПолучитьНастройкиПодключения();
		HTTPСоединение = Новый HTTPСоединение(НастройкиПодключения.URLСервера, , , , , 5);
		HTTPЗапрос = Новый HTTPЗапрос("/health");
		Ответ = HTTPСоединение.Получить(HTTPЗапрос);
		
		ВремяОкончания = ТекущаяУниверсальнаяДатаВМиллисекундах();
		Статус.ВремяОткликаМС = ВремяОкончания - ВремяНачала;
		
		Если Ответ.КодСостояния <> 200 Тогда
			Статус.Статус = "Degraded";
			Статус.Сообщение = "API отвечает с ошибкой: " + Ответ.КодСостояния;
		ИначеЕсли Статус.ВремяОткликаМС > 5000 Тогда
			Статус.Статус = "Degraded";
			Статус.Сообщение = "Медленный отклик API: " + Статус.ВремяОткликаМС + " мс";
		КонецЕсли;
		
	Исключение
		Статус.Статус = "Unhealthy";
		Статус.Сообщение = "API недоступен";
	КонецПопытки;
	
	Возврат Статус;
	
КонецФункции

// Проверить очередь
//
Функция ПроверитьОчередь()
	
	Статус = Новый Структура;
	Статус.Вставить("Статус", "Healthy");
	Статус.Вставить("Сообщение", "");
	
	СтатистикаОчереди = МодульОчередей.ПолучитьСтатистикуОчереди();
	
	Если СтатистикаОчереди.ВОжидании > 1000 Тогда
		Статус.Статус = "Degraded";
		Статус.Сообщение = "Большая очередь: " + СтатистикаОчереди.ВОжидании + " задач";
	ИначеЕсли СтатистикаОчереди.Ошибка > 100 Тогда
		Статус.Статус = "Degraded";
		Статус.Сообщение = "Много ошибок: " + СтатистикаОчереди.Ошибка;
	КонецЕсли;
	
	Возврат Статус;
	
КонецФункции

// Проверить кеш
//
Функция ПроверитьКеш()
	
	Статус = Новый Структура;
	Статус.Вставить("Статус", "Healthy");
	Статус.Вставить("Сообщение", "");
	
	СтатистикаКеша = МодульКеширования.ПолучитьСтатистикуКеша();
	
	Если СтатистикаКеша.HitRate < 50 Тогда
		Статус.Статус = "Degraded";
		Статус.Сообщение = "Низкий Hit Rate: " + СтатистикаКеша.HitRate + "%";
	КонецЕсли;
	
	Возврат Статус;
	
КонецФункции

// Получить количество ошибок за период
//
Функция ПолучитьКоличествоОшибокЗаПериод()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(СобытияОпераций.УИДОперации) КАК Количество
	|ИЗ
	|	РегистрСведений.СобытияОпераций КАК СобытияОпераций
	|ГДЕ
	|	СобытияОпераций.СтатусОперации = ""Ошибка""
	|	И СобытияОпераций.Период МЕЖДУ &НачалоДня И &КонецДня";
	
	Запрос.УстановитьПараметр("НачалоДня", НачалоДня(ТекущаяДатаСеанса()));
	Запрос.УстановитьПараметр("КонецДня", КонецДня(ТекущаяДатаСеанса()));
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат 0;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Количество;
	
КонецФункции

#КонецОбласти

// ====================================================================
// АРХИТЕКТУРНЫЕ РЕШЕНИЯ:
// 
// 1. Observer Pattern - автоматический сбор метрик
// 2. Event Sourcing - запись всех событий для audit trail
// 3. Time Series Data - временные ряды для анализа трендов
// 4. Health Check Pattern - проверка здоровья компонентов
// 5. Alert Pattern - уведомления при превышении порогов
// 6. Dashboard Pattern - агрегация ключевых показателей
// 
// МЕТРИКИ:
// - Производительность (время выполнения, throughput)
// - Качество (процент ошибок, успешность операций)
// - Ресурсы (использование кеша, размер очереди)
// - Доступность (health checks внешних систем)
// 
// ИСПОЛЬЗОВАНИЕ:
// Dashboard = МодульМониторинга.ПолучитьDashboard();
// Сообщить("Кеш Hit Rate: " + Dashboard.Кеш.HitRate + "%");
// Сообщить("Очередь: " + Dashboard.Очередь.ВОжидании + " задач");
// ====================================================================

